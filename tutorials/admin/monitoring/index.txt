.. _geonode_monitoring:

GeoNode Monitoring
==================


Internal Monitoring Application (geonode.contrib.monitoring)
------------------------------------------------------------

Base concepts and objects
~~~~~~~~~~~~~~~~~~~~~~~~~

 GeoNode monitoring is a configurable monitoring application, that allows internal resources and hardware resources monitoring for GeoNode installations, including GeoServer deployments.

 Monitoring application is configurable, so different deployment scenarios could be handled - from GeoNode and GeoServer running on single host, through distributed installations, where GeoServer is deployed to several hosts.

 Monitoring application uses three base entity classes to describe elements of reality: Host, Service Type and Service. 

 * Host is an object describing physical (or virtual) instance of operating system on which GN or GS is running. This object exists only for grouping and is not used directly by monitoring. 

 * Service Type is a description of kind of Service. Depending on service type, different metrics are stored, and different data collection mechanisms are used. Additionally, for system monitoring, it's not conducted directly, but with GeoNode or GeoServer as monitoring agent. That means, no additional software installation is needed to monitor system, but also, hosts that don't have GeoNode or GeoServer installed, won't be monitored. There are four service types:
   
   * hostgeonode, hostgeoserver - those types describe system monitoring probes that are running with GeoNode or GeoServer respectively,

   * geonode, geoserver - application-level probes that monitor one specific GeoNode or GeoServer instance.

 * Service describes one specific instance of probe, either host-level or application-level. Service references Host and Service Type. Each service must be named, and name should be system-wide unique.

 As mentioned above, each Service Type keeps a set of metrics, specific for that type. A metric is a description of measured value, for example: number of requests, response size or time, cpu usage, free memory etc. Each Service Type has it's own metrics set. Metric value may be either value counter (like country of user), numeric counter (like number of requests) or rate (like bytes in/out on network interface).

Installation
~~~~~~~~~~~~

 * enable ``MONITORING_ENABLED`` flag
 * ensure that following code is in your settings:

::

  MONITORING_ENABLED = True
  # add following lines to your local settings to enable monitoring
  if MONITORING_ENABLED:
      INSTALLED_APPS += ('geonode.contrib.monitoring',)
      MIDDLEWARE_CLASSES += ('geonode.contrib.monitoring.middleware.MonitoringMiddleware',)
      MONITORING_SERVICE_NAME = 'local-system-geonode' # or other name for your main geonode instance Service
      NOTIFICATION_ENABLED = True

* run ``manage.py migrate monitoring`` to apply db schema changes and insert initial data
* add ``manage.py collect_metrics`` call to crontab.

Configuration
~~~~~~~~~~~~~

In order to have working monitoring, at least Service should be configured. Let's assume following deployment scenario:
    * there's one machine, ``geo01``
    * ``geo01`` hosts both GeoNode and GeoServer (including PostgreSQL). 
    * applications are served with nginx+uwsgi, on port 80, but they are reachable on ``localhost`` address.
    * GeoServer is served from ``/geoserver/`` path
    * GeoNode is served from ``/`` path

Here's step-by-step instruction how to create monitoring setup for deployment scenario:


1. Log in as admin, and go to admin section:

.. image:: ../../../img/monitoring/homepage-admin-link.png
   :alt: go to admin section

2. Go to **monitoring** section (or type ``/admin/monitoring/`` as a path in URL): 

.. image:: ../../../img/monitoring/admin-monitoring-section.png
   :alt: go to admin/monitoring section

3. Go to **Hosts**:

.. image:: ../../../img/monitoring/admin-monitoring-hosts-services-underline.png
   :alt: go to admin/monitoring/hosts section

4. Click on **Add host +**:

.. image:: ../../../img/monitoring/admin-monitoring-add-host.png
   :alt: add host

5. Enter following information:
   * **host**: `localhost`
   * **ip**: `127.0.0.1`
   Note, that **host** value is arbitrary. You can enter other name if you like.
   Don't forget to save.

.. image:: ../../../img/monitoring/admin-monitoring-host.png
   :alt: added host

6. Go to **Services**:

.. image:: ../../../img/monitoring/admin-monitoring-hosts-services-underline.png
   :alt: go to admin/monitoring/services section

7. Click on **Add service +**:

.. image:: ../../../img/monitoring/admin-monitoring-add-service.png
   :alt: add service

8. Enter following information:

   * **name**: `local-geonode`
   * **host**: `localhost`
   * **service type**: `geonode`

.. image:: ../../../img/monitoring/admin-monitoring-service-local-geonode.png
   :alt: add geonode service

9. Add another **Service** Enter following information:

   * **name**: `local-system-geonode`
   * **host**: `localhost`
   * **service type**: `hostgeonode`
   * **url**: `http://localhost/` (should point to GeoNode home page)

.. image:: ../../../img/monitoring/admin-monitoring-service-local-system-geonode.png
   :alt: add hostgeonode service

10. Add another **Service** and enter following information:

   * **name**: `local-geoserver`
   * **host**: `localhost`
   * **service type**: `geoserver`
   * **url**: `http://localhost/geoserver/` (should point to GeoServer home page)

.. image:: ../../../img/monitoring/admin-monitoring-service-local-geoserver.png
   :alt: add geoserver service


To summarize, following entries should be created in admin/monitoring:

* Host: ``localhost``, with ip: 127.0.0.1
* Service: ``local-geonode``:
   * host ``localhost``
   * type ``geonode``
* Service: ``local-geoserver``:
   * url ``http://localhost/geoserver/``
   * host ``localhost``
   * type ``geoserver``
* Service: ``local-system-geonode``
   * url ``http://localhost/``
   * host ``localhost``
   * type ``hostgeonode``

Usage
=====

Monitoring interface is available for superusers only. It's available in profile menu:

.. image:: ../../../img/monitoring/homepage-monitoring-link.png
   :alt: monitoring link


Tips & tricks
=============
